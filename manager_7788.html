<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>অ্যাডমিন প্যানেল</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; margin: 0; display: flex; }
        .sidebar { width: 250px; background-color: #2c3e50; color: white; height: 100vh; position: fixed; overflow-y: auto; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar ul li { padding: 15px 20px; cursor: pointer; border-bottom: 1px solid #34495e; }
        .sidebar ul li:hover, .sidebar ul li.active { background-color: #3498db; }
        .main-content { margin-left: 250px; flex-grow: 1; padding: 30px; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f8f9fa; }
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; margin: 2px; }
        .btn-g { background: #28a745; } .btn-r { background: #dc3545; } .btn-b { background: #007bff; }
        input, textarea { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        .chat-window { border: 1px solid #ccc; height: 300px; overflow-y: auto; padding: 10px; margin-bottom: 10px; background: #f9f9f9; }
        .msg { padding: 5px 10px; margin: 5px; border-radius: 10px; display: inline-block; clear: both; }
        .msg-u { background: #e1f5fe; float: left; }
        .msg-a { background: #007bff; color: white; float: right; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3 style="text-align:center;">অ্যাডমিন</h3>
        <ul>
            <li onclick="show('dash')" class="active">ড্যাশবোর্ড</li>
            <li onclick="show('req')">পেন্ডিং রিকোয়েস্ট</li>
            <li onclick="show('users')">ইউজার & ট্র্যাকিং</li>
            <li onclick="show('pack')">প্যাকেজ ম্যানেজ</li>
            <li onclick="show('chat')">লাইভ চ্যাট</li>
            <li onclick="show('set')">সেটিংস</li>
        </ul>
    </div>

    <div class="main-content">
        <div id="dash" class="page-section active">
            <h1>ড্যাশবোর্ড</h1>
            <div class="card"><h3>সার্ভার: <span style="color:green">অনলাইন ✅</span> | একটিভ ইউজার: <span id="active-count">0</span></h3></div>
        </div>

        <div id="req" class="page-section">
            <h1>পেন্ডিং রিকোয়েস্ট</h1>
            <div class="card">
                <h3>জমা</h3>
                <table><thead><tr><th>User (Loc)</th><th>Details</th><th>Amount (Bonus)</th><th>Action</th></tr></thead><tbody id="dep-list"></tbody></table>
                <h3>তোলা</h3>
                <table><thead><tr><th>User (Loc)</th><th>Details</th><th>Amount</th><th>Action</th></tr></thead><tbody id="wid-list"></tbody></table>
            </div>
        </div>

        <div id="users" class="page-section">
            <h1>ইউজার ম্যানেজমেন্ট</h1>
            <div class="card">
                <input id="search" onkeyup="filter()" placeholder="আইডি সার্চ...">
                <button class="btn btn-b" onclick="loadUsers()">রিফ্রেশ</button><br><br>
                <table><thead><tr><th>User</th><th>Loc & IP</th><th>Bal</th><th>Action</th></tr></thead><tbody id="user-list"></tbody></table>
            </div>
        </div>

        <div id="pack" class="page-section">
            <h1>প্যাকেজ ম্যানেজ</h1>
            <div class="card">
                <input id="p-name" placeholder="প্যাকেজ নাম (যেমন: VIP 1)">
                <input id="p-price" type="number" placeholder="দাম (যেমন: 710)">
                <input id="p-bonus" type="number" placeholder="বোনাস (যেমন: 2130)">
                <button class="btn btn-g" onclick="addPack()">যোগ করুন</button><br><br>
                <table><thead><tr><th>Name</th><th>Price</th><th>Bonus</th><th>Action</th></tr></thead><tbody id="pack-list"></tbody></table>
            </div>
        </div>

        <div id="chat" class="page-section">
            <h1>লাইভ চ্যাট</h1>
            <div class="card" style="display:flex; gap:20px;">
                <div style="width:30%; border-right:1px solid #ccc;" id="chat-users"></div>
                <div style="width:70%;">
                    <h4 id="chat-with">Select User</h4>
                    <div class="chat-window" id="chat-display"></div>
                    <input id="chat-msg" style="width:70%"> <button class="btn btn-b" onclick="sendChat()">Send</button>
                </div>
            </div>
        </div>

        <div id="set" class="page-section">
            <h1>সেটিংস</h1>
            <div class="card">
                <label>হেডার টেক্সট (User App):</label><br><textarea id="header-text" style="width:100%"></textarea><button class="btn btn-b" onclick="saveSet('headerText')">Save</button><br><br>
                <label>নোটিশ:</label><br><textarea id="notice" style="width:100%"></textarea><button class="btn btn-b" onclick="saveSet('notice')">Save</button><br><br>
                <label>নিয়ম:</label><br><textarea id="rules" style="width:100%"></textarea><button class="btn btn-b" onclick="saveSet('rules')">Save</button><br><br>
                <label>বিকাশ:</label><input id="bkash"> <label>নগদ:</label><input id="nagad"> <button class="btn btn-b" onclick="saveNum()">Save</button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyCF9cqEoQwPow2VbB0Koj1yyy4QMDofPQE",
          authDomain: "investmentwebsite1.firebaseapp.com",
          databaseURL: "https://investmentwebsite1-default-rtdb.firebaseio.com", 
          projectId: "investmentwebsite1",
          storageBucket: "investmentwebsite1.firebasestorage.app",
          messagingSenderId: "592540774650",
          appId: "1:592540774650:web:1ad31bf96cbc8c60db1943",
          measurementId: "G-QLTC23GYRE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function show(id) {
            document.querySelectorAll('.page-section').forEach(p=>p.style.display='none');
            document.getElementById(id).style.display='block';
            if(id==='users') loadUsers();
            if(id==='pack') loadPacks();
            if(id==='chat') loadChatUsers();
        }
        show('dash');

        // রিকোয়েস্ট
        db.ref('deposits').orderByChild('status').equalTo('pending').on('value', s => {
            const l = document.getElementById('dep-list'); l.innerHTML='';
            s.forEach(d => {
                l.innerHTML += `<tr><td>${d.val().userName}<br>${d.val().location||'N/A'}</td>
                <td>${d.val().method}<br>${d.val().trxId}</td>
                <td>৳${d.val().amount} (Bonus: ${d.val().bonus})</td>
                <td><button class="btn btn-g" onclick="proc('${d.key}','deposits',true,${d.val().bonus},'${d.val().userId}')">✔</button>
                <button class="btn btn-r" onclick="proc('${d.key}','deposits',false)">✖</button></td></tr>`;
            });
        });
        db.ref('withdrawals').orderByChild('status').equalTo('pending').on('value', s => {
            const l = document.getElementById('wid-list'); l.innerHTML='';
            s.forEach(d => {
                l.innerHTML += `<tr><td>${d.val().userName}<br>${d.val().location||'N/A'}</td>
                <td>${d.val().number}<br>${d.val().method}</td>
                <td>৳${d.val().amount}</td>
                <td><button class="btn btn-g" onclick="proc('${d.key}','withdrawals',true,0)">✔</button>
                <button class="btn btn-r" onclick="proc('${d.key}','withdrawals',false,${d.val().amount},'${d.val().userId}')">✖</button></td></tr>`;
            });
        });

        function proc(k, type, ok, amt, uid) {
            if(!confirm('Confirm?')) return;
            if(ok) {
                if(type==='deposits') db.ref('users/'+uid+'/balance').transaction(c=>(c||0)+amt);
                db.ref(type+'/'+k).update({status:'approved'});
            } else {
                if(type==='withdrawals') db.ref('users/'+uid+'/balance').transaction(c=>(c||0)+amt);
                db.ref(type+'/'+k).update({status:'rejected'});
            }
        }

        // ইউজার ও ব্যান
        async function loadUsers() {
            const l = document.getElementById('user-list'); l.innerHTML='loading...';
            const s = await db.ref('users').get();
            l.innerHTML='';
            let count = 0;
            const today = new Date().toISOString().split('T')[0];
            s.forEach(u => {
                const v = u.val();
                if(v.last_active && v.last_active.includes(today)) count++;
                l.innerHTML += `<tr>
                    <td>${v.name}<br><small>${u.key}</small></td>
                    <td>${v.location||'N/A'}<br><small>${v.ip||'N/A'}</small></td>
                    <td>${v.balance} <button onclick="editBal('${u.key}')">✏</button></td>
                    <td><button class="btn ${v.isBanned?'btn-g':'btn-r'}" onclick="toggleBan('${u.key}', ${v.isBanned})">${v.isBanned?'Unban':'Ban'}</button></td>
                </tr>`;
            });
            document.getElementById('active-count').innerText = count;
        }
        function toggleBan(uid, status) {
            if(confirm(status ? "Unban?" : "Ban?")) db.ref('users/'+uid).update({isBanned: !status}).then(()=>loadUsers());
        }
        function editBal(uid){
            let n = prompt("New Balance:");
            if(n) db.ref('users/'+uid).update({balance: parseFloat(n)}).then(()=>loadUsers());
        }
        function filter() {
            const f = document.getElementById('search').value.toUpperCase();
            const tr = document.getElementById('user-list').getElementsByTagName('tr');
            for(let i=0; i<tr.length; i++) {
                const td = tr[i].getElementsByTagName('td')[0];
                tr[i].style.display = td && td.innerHTML.toUpperCase().indexOf(f)>-1 ? "" : "none";
            }
        }

        // প্যাকেজ
        function loadPacks() {
            db.ref('packages').on('value', s => {
                const l = document.getElementById('pack-list'); l.innerHTML='';
                s.forEach(p => {
                    l.innerHTML += `<tr><td>${p.val().name}</td><td>${p.val().price}</td><td>${p.val().bonus}</td>
                    <td><button class="btn btn-r" onclick="if(confirm('Delete?')) db.ref('packages/${p.key}').remove()">Del</button></td></tr>`;
                });
            });
        }
        function addPack() {
            const n=document.getElementById('p-name').value, p=document.getElementById('p-price').value, b=document.getElementById('p-bonus').value;
            if(n&&p) db.ref('packages').push({name:n, price:parseFloat(p), bonus:parseFloat(b)});
        }

        // চ্যাট
        let chatU = null;
        function loadChatUsers() {
            db.ref('chats').on('value', s => {
                const l = document.getElementById('chat-users'); l.innerHTML='';
                s.forEach(u => {
                    l.innerHTML += `<div style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;" onclick="openChat('${u.key}')">${u.key}</div>`;
                });
            });
        }
        function openChat(uid) {
            chatU = uid; document.getElementById('chat-with').innerText = 'Chat: '+uid;
            db.ref('chats/'+uid).limitToLast(20).on('value', s => {
                const d = document.getElementById('chat-display'); d.innerHTML='';
                s.forEach(m => {
                    const c = m.val().sender==='admin'?'msg-a':'msg-u';
                    d.innerHTML += `<div class="msg ${c}">${m.val().text}</div>`;
                });
                d.scrollTop = d.scrollHeight;
            });
        }
        function sendChat() {
            const t = document.getElementById('chat-msg').value;
            if(chatU && t) { db.ref('chats/'+chatU).push({sender:'admin', text:t, timestamp:new Date().toISOString()}); document.getElementById('chat-msg').value=''; }
        }

        // সেটিংস
        function saveSet(k) { 
            const val = document.getElementById(k==='notice'?'notice':(k==='rules'?'rules':'header-text')).value;
            db.ref('settings/'+k).set({text: val}).then(()=>alert('Saved'));
        }
        function saveNum() {
            db.ref('settings/paymentNumbers').set({
                bkash: document.getElementById('bkash').value,
                nagad: document.getElementById('nagad').value
            }).then(()=>alert('Saved'));
        }
        
        db.ref('settings').get().then(s=>{
            if(s.exists()){
                if(s.val().notice) document.getElementById('notice').value=s.val().notice.text;
                if(s.val().rules) document.getElementById('rules').value=s.val().rules.text;
                if(s.val().headerText) document.getElementById('header-text').value=s.val().headerText.text;
                if(s.val().paymentNumbers) { document.getElementById('bkash').value=s.val().paymentNumbers.bkash; document.getElementById('nagad').value=s.val().paymentNumbers.nagad; }
            }
        });
    </script>
</body>
</html>
